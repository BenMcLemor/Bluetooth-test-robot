name: Bluetooth App CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-22.04

    steps:
    # --------------------------------------------------
    # 1. Checkout source code
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # --------------------------------------------------
    # 2. Debug OS (sanity check)
    # --------------------------------------------------
    - name: Debug OS version
      run: |
        lsb_release -a
        cat /etc/os-release

    # --------------------------------------------------
    # 3. Clean any old/broken ROS APT config
    # --------------------------------------------------
    - name: Cleanup old ROS APT configuration
      run: |
        sudo rm -f /etc/apt/sources.list.d/ros*
        sudo rm -f /etc/apt/trusted.gpg.d/ros*
        sudo apt-get update

    # --------------------------------------------------
    # 4. Install UPDATED ROS GPG key (fix EXPKEYSIG)
    # --------------------------------------------------
    - name: Install ROS GPG key
      run: |
        sudo apt-get install -y curl gnupg lsb-release
        sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
          -o /usr/share/keyrings/ros-archive-keyring.gpg

    # --------------------------------------------------
    # 5. Add ROS 2 apt repository (jammy)
    # --------------------------------------------------
    - name: Add ROS 2 repository
      run: |
        echo "deb [signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] \
        http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | \
        sudo tee /etc/apt/sources.list.d/ros2.list

    # --------------------------------------------------
    # 6. Setup ROS 2 Humble
    # --------------------------------------------------
    - name: Setup ROS 2 Humble
      uses: ros-tooling/setup-ros@v0.5
      with:
        ros-distro: humble

    # --------------------------------------------------
    # 7. Install dependencies via rosdep
    # --------------------------------------------------
    - name: Install ROS dependencies
      run: |
        sudo rosdep init || true
        rosdep update
        rosdep install --from-paths src --ignore-src -r -y

    # --------------------------------------------------
    # 8. Build ROS 2 workspace
    # --------------------------------------------------
    - name: Build ROS 2 workspace
      shell: bash
      run: |
        source /opt/ros/humble/setup.bash
        colcon build --event-handlers console_direct+
        echo "✅ Build successful"

    # --------------------------------------------------
    # 9. Run basic runtime test (simulated)
    # --------------------------------------------------
    - name: Run ROS 2 runtime test
      shell: bash
      run: |
        source /opt/ros/humble/setup.bash
        source install/setup.bash
        timeout 10s ros2 run my_bt_test simple_scanner || true
        echo "✅ Runtime test completed"

    # --------------------------------------------------
    # 10. (Optional) Build Docker image
    # --------------------------------------------------
    - name: Build Docker image
      run: |
        docker build \
          -f docker/Dockerfile \
          -t ghcr.io/${{ github.repository }}:latest .
        echo "✅ Docker image built"
