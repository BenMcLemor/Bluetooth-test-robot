name: CI/CD for Raspberry Pi ARM

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io

jobs:
  build-test:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Fix and Install ROS2
      run: |
        # Fix expired GPG key
        sudo apt-get update
        sudo apt-get install -y curl gnupg lsb-release
        sudo rm -f /usr/share/keyrings/ros-archive-keyring.gpg
        sudo curl -fsSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/ros2.list
        sudo apt-get update
        sudo apt-get install -y ros-humble-ros-base python3-colcon-common-extensions
    
    - name: Build ROS2 workspace
      run: |
        source /opt/ros/humble/setup.bash
        colcon build --symlink-install
        echo "✅ Build successful"

  build-docker-arm:
    needs: build-test
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up QEMU for ARM
      uses: docker/setup-qemu-action@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Convert repo name to lowercase
      run: |
        echo "IMAGE_NAME_LOWER=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV
    
    - name: Build and push ARM Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/Dockerfile
        platforms: linux/arm64
        push: true
        tags: |
          ghcr.io/benmclemor/bluetooth-test-robot:latest
          ghcr.io/benmclemor/bluetooth-test-robot:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-to-pi:
    needs: build-docker-arm
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.RPI_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.RPI_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to Raspberry Pi
      run: |
        ssh ${{ secrets.RPI_USER }}@${{ secrets.RPI_HOST }} << 'EOF'
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker pull ghcr.io/benmclemor/bluetooth-test-robot:latest
        docker stop bluetooth-app 2>/dev/null || true
        docker rm bluetooth-app 2>/dev/null || true
        docker run -d --name bluetooth-app --privileged --net=host ghcr.io/benmclemor/bluetooth-test-robot:latest
        echo "✅ Deployed!"
        EOF
