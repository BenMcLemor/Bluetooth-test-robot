name: Build and Push ARM Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Fix and Install ROS2
      run: |
        sudo apt-get update
        sudo apt-get install -y curl gnupg lsb-release
        sudo rm -f /usr/share/keyrings/ros-archive-keyring.gpg
        sudo curl -fsSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/ros2.list
        sudo apt-get update
        sudo apt-get install -y ros-humble-ros-base python3-colcon-common-extensions
    
    - name: Build and Test
      run: |
        source /opt/ros/humble/setup.bash
        colcon build --symlink-install
        timeout 10s ros2 run my_bt_test simple_scanner &
        sleep 3
        echo "âœ… Build and test successful"

  build-push:
    needs: build-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push ARM Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/Dockerfile
        platforms: linux/arm64
        push: true
        tags: |
          ghcr.io/benmclemor/bluetooth-test-robot:latest
          ghcr.io/benmclemor/bluetooth-test-robot:${{ github.sha }}
    
    - name: Build Success Notification
      run: |
        echo "âœ… ARM Docker Image built and pushed!"
        echo ""
        echo "ðŸ“¦ Image: ghcr.io/benmclemor/bluetooth-test-robot:latest"
        echo "ðŸ”— SHA: ghcr.io/benmclemor/bluetooth-test-robot:${{ github.sha }}"
        echo ""
        echo "ðŸ¤– Your Raspberry Pi will auto-pull this image within 5 minutes"
        echo ""
        echo "ðŸ“‹ Manual update on Pi:"
        echo "ssh pi@192.168.1.138"
        echo "docker pull ghcr.io/benmclemor/bluetooth-test-robot:latest"
        echo "docker run -d --name bt-app --privileged --net=host ghcr.io/benmclemor/bluetooth-test-robot:latest"
